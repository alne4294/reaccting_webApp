<!DOCTYPE html>
<html>
<html>

<head>
    <meta charset="utf-8">
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <title>Phone GPS</title>

    <!-- <link rel='stylesheet' href='https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.css'  /> -->
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css" />
    <link href="static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="static/css/leaflet.awesome-markers.css">
    <link rel="stylesheet" type="text/css" href="static/css/animationStyle.css">

</head>

<body>

<!-- <script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.js'></script> -->
<script src='static/bower_components/d3/d3.min.js'></script>
<script src='static/bower_components/jquery/dist/jquery.min.js'></script>
<script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
<script src="static/Bing.js"></script> 
<script src="http://maps.google.com/maps/api/js?v=3&sensor=false"></script>
<script src="static/Google.js"></script>
<script src="static/leaflet.awesome-markers.js"></script>
<!-- <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.css' rel='stylesheet' /> -->

<div id='map'></div>

<div class="dateTimeBox box" style="display: block;">
    <!-- <div class = "date"></div>  -->
    <div class = "time"><span class = "readableTime"></span></div> 
<!--     <div class= "controls">
        <button type="button" class="btn btn-default btn-xs slower"><span class="glyphicon glyphicon-backward"></span> Slower</button>
        <button type="button" class="btn btn-default btn-xs faster">Faster <span class="glyphicon glyphicon-forward"></span> </button>   
    </div> -->
    <!-- <div>Time Factor: <span class = "timeFactor"></span> minutes per second</div> -->
</div>

<script>

  // custom javascript
  $(function() {
    var phoneNum = 2;
    console.log('About to animate :)');
    getPhoneData(phoneNum);
  });


  function getPhoneData(phoneNum){
    d3.json("/api/1.0/mongoWebApp/getPhoneData/"+phoneNum, function(docs) {
      
      //docs.data is an array of objects, where each obj is a csv row
      var dataObjs = (docs.data);
      // console.log(typeof(dataObjs));

      var numRecords = dataObjs.length;
      var lats  = [];
      var longs = [];
      var records = [];
      var latTot = 0;
      var lonTot = 0;

      for (var i = 0; i < numRecords; i++){
        var record = dataObjs[i];
        if (i<5){
          console.log("RECORD");
          console.log(record);
        }
        var lat = Number(record.lat);
        var lon = Number(record.lon);

        //Check that our coordinates are numerical and within the acceptable area
        if(!isNaN(lat) && lat<11.109684643110414 && lat>10.478359299402134){
          if(!isNaN(lon) && lon<-0.693511962890625 && lon>-1.41998291015625){

            //Get running total of lat and lon so we can get avg to know where to center the map
            latTot += lat;
            lonTot += lon;

            lats.push(lat);
            longs.push(lon);
            records.push(record);
          }
        }
      }

      console.log("Started with: " + numRecords + " records");
      var prunedNumRecords = lats.length;
      console.log(prunedNumRecords + " were permissable")

      var latAvg = latTot/prunedNumRecords;
      var lonAvg = lonTot/prunedNumRecords;

      //Call from here to avoid asynchronous behavior
      animatePhoneData(lats, longs, records, latAvg, lonAvg);

    });
  }

  function animatePhoneData(lats, longs, records, latAvg, lonAvg){

    // add a Google Maps tile layer
    var zoomLevel = 15; //higher zoom gets closer in
    var map = new L.Map('map', {center: new L.LatLng(latAvg, lonAvg), zoom: zoomLevel});
    var osm = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    var ggl = new L.Google();
    var ggl2 = new L.Google('TERRAIN');
    map.addLayer(ggl);
    map.addControl(new L.Control.Layers( {'OSM':osm, 'Google':ggl, 'Google Terrain':ggl2}, {}));

    // add a Bing Maps tile layer
    // var map = new L.Map('map', {center: new L.LatLng(10.9100667, -1.0007569), zoom: 12 });
    // var bing = new L.BingLayer('Apb30DxKsPr3GNnsoElz70LlkgOSsKZe3PjWEa9__-huHzyMYYQB45vP8m7MjL3c');
    // map.addLayer(bing);

    // add a MapBox tile layer
    // L.mapbox.accessToken = 'pk.eyJ1IjoiYWxuZTQyOTQiLCJhIjoiZERWYV8yZyJ9.9Dp7x2OGFrLO6ZIunDSHyQ';
    // var map = L.mapbox.map('map', 'alne4294.l9ebdngb').setView([10.9100667, -1.0007569], 12);

    // add an OpenStreetMap tile layer
    // L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    //     attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    // }).addTo(map);

    // Generate a GeoJSON line. You could also load GeoJSON via AJAX
    // or generate it some other way.
    var geojson = { type: 'LineString', coordinates: [] };

    console.log(lats);
    console.log(longs);

    var start = [0,0];
    var momentum = [.001, .001];
    var pace = 30; //Higher number is a slower pace

    for (var i = 0; i < lats.length; i++){

      //Push the start of the line, then start moving towards the next point
      start[0] = lats[i];
      start[1] = longs[i];

      geojson.coordinates.push(start.slice());
     
      var latMom  = Math.abs(lats[i+1]  - lats[i])/pace;
      var longMom = Math.abs(longs[i+1] - longs[i])/pace;
      momentum = [latMom, longMom];

      //The direction of the momentum depends on the direction that we're going
      //Note: since we've scaled the momentum for N/S and E/W, we only need to check
      //one of them to determine if we've reached our destination

      //NORTHEAST
      if(lats[i] <= lats[i+1] && longs[i] <= longs[i+1]){
        while(start[0] < lats[i+1]){
          // Use the momentum to smooth transitions
          start[0] += momentum[0];
          start[1] += momentum[1];
          geojson.coordinates.push(start.slice());
        } 
      }

      //NORTHWEST
      else if(lats[i] <= lats[i+1] && longs[i] >= longs[i+1]){
        while(start[0] < lats[i+1]){
          // Use the momentum to smooth transitions
          start[0] += momentum[0];
          start[1] -= momentum[1];
          geojson.coordinates.push(start.slice());
        } 
      }

      //SOUTHEAST
      else if(lats[i] >= lats[i+1] && longs[i] <= longs[i+1]){
        while(start[0] > lats[i+1]){
          // Use the momentum to smooth transitions
          start[0] -= momentum[0];
          start[1] += momentum[1];
          geojson.coordinates.push(start.slice());
        } 
      }

      //SOUTHWEST
      else if(lats[i] >= lats[i+1] && longs[i] >= longs[i+1]){
        while(start[0] > lats[i+1]){
          // Use the momentum to smooth transitions
          start[0] -= momentum[0];
          start[1] -= momentum[1];
          geojson.coordinates.push(start.slice());
        } 
      }

    }

    console.log(geojson);

    // Add this generated geojson object to the map.
    L.geoJson(geojson).addTo(map);

    // Create a counter with a value of 0.
    var j = 0;

    // Create a marker and add it to the map.
    // var marker = L.marker([0, 0], {
    //   icon: "L.mapbox.marker.icon"({
    //     'marker-color': '#f86767'
    //   })
    // }).addTo(map);

    // var marker = L.marker([0, 0]).addTo(map);

    var phoneMarker = L.AwesomeMarkers.icon({
      icon: 'mobile-phone', 
      markerColor: 'red',
      prefix: 'fa', 
      iconColor: 'white'
    });

    var marker = L.marker([0,0], {icon: phoneMarker}).addTo(map)
        .bindPopup('Phone');

    var circle = L.circle([0,0], 250, {
        fill: true,
        color: 'gold',
        fillColor: 'yellow',
        fillOpacity: 0.18
    }).addTo(map);

    // var marker = g.append("circle");
    // marker.attr("r", 5)
    // .attr("id", "marker");

    tick();

    function tick() {
        // Set the marker to be at the same point as one
        // of the segments or the line.
        marker.setLatLng(L.latLng(
            geojson.coordinates[j][0],
            geojson.coordinates[j][1]));

        circle.setLatLng(L.latLng(
            geojson.coordinates[j][0],
            geojson.coordinates[j][1]))

        var accuracy = Number(records[j].gpsacc)
        if (accuracy <= 100){
          circle.setRadius( 250+(.35*accuracy) )
        }
        
        updateTimer();

        // Move to the next point of the line
        // until `j` reaches the length of the array.
        if (++j < geojson.coordinates.length) setTimeout(tick, 100);
    }

    function updateTimer() {
        // time.add('minutes',1);
        $('.readableTime').text(records[j].time);
        // $('.date').text(time.format('dddd, MMMM Do YYYY'));
        // timer = setTimeout(function(){updateTimer()},(1000/timeFactor));
    }
  }
</script>

</body>
</html>